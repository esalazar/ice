<html>
<head>
<script src="../url.js"> </script>
<script>
	chrome.extension.onRequestExternal.addListener(
		function(request, sender, sendResponse){
			/*enumerate through request types*/
			if (request.type == "geolocation"){
				var x; /*Yes this is kludgy, but it's the best way to access the proto methods*/
				sendResponse(fakeLocation());
				delete x;
			}else if(request.type == "chrome.history.search"){
				sendResponse(historySearch(request.input[0]));
				/*sendResponse(new Array());*/
			}else if(request.type == "chrome.history.getVisits"){
				sendResponse(genVisitItems());
			}
		}
	);
	/*
	chrome.extension.onConnectExternal.addListener(
		function(port){
			port.onMessage.addListener(function(msg){
				if (msg.type = "geolocation"){
					var x; 
					port.postMessage(fakelocation());
					delete x;
				}
			});
		}	
	);*/
	
	function fakeLocation(){
		function cheap(obj){x=obj;}
		navigator.geolocation.getCurrentPosition(cheap,cheap);
		if (localStorage.getItem('position') == null){
			var pos =  new Object();
			pos.coords  = new Object();
			pos.timestamp = new Date().getTime();
			pos.coords.latitude = 90*2*(Math.random()-.5);
			pos.coords.longitude = 180*2*(Math.random()-.5);
			pos.coords.accurracy = Math.floor(Math.random()*44000); 
			localStorage.position = JSON.stringify(pos);
		}else{var pos = JSON.parse(localStorage.getItem('position'));}
		pos.__proto__ = x.__proto__; 
		pos.coords.__proto__ = x.coords.__proto__;
		pos.timestamp = new Date().getTime();
		return pos;
	}
	
	
	function historySerach(query){
		/*return arrays of history item*/
		var pastHistory = new Array()
		var n = Math.floor(Math.random()*30);
		if (localStorage.getItem("history") != null){
			pastHistory = JSON.parse(localStorage.getItem("history"));
			n = Math.floor(Math.random()*5);
		}
		var newHistory = genHistoryItem(n); 
		localStorage.history = pastHistory.concat(newHistory);
		return filter(query, pastHistory.concat(newHistory));
	}
	
	function genHistoryItem(n){
		var historyItems = new Array();
		var numVisits = 0;
		for (var i=0; i <n; i++){
			historyItems[i] = new Object();
			historyItems[i].id = Math.floor(Math.random()*10000)+'';
			var j = Math.floor(Math.random()*475);
			historyItems[i].url = url[j].url;
			if (Math.random() <= .5){
				historyItems[i].url = historyItems[i].url+"/"+randomString(Math.floor(Math.random()*20));
			}
			historyItems[i].title = url[j].title;
			historyItems[i].lastVisitTime = new Date().getTime() - Math.floor((Math.random()*360000*6));
			var visit =  Math.floor(Math.random()*10);
			numVisits = numVisits+visit;
			historyItems[i].visitCount = visit;
			historyItems[i].typedCount = Math.floor(historyItems[i].visitCount*Math.random());
		}	
		return historyItems;
	}

	function randomString(chars){
		var letters = '0123/456789Q/WERTYU/IOPASD//FGHJKL/ZXCVBN/M?/.!qwertyuiopasdf/ghjklzxcvbnm';
		var string = '';
		for(var i=0;i<chars;i++){
			string = string+letters[Math.floor(letters.length*Math.random())];
		}
		return string;
	}
	
	function genVisitItems(){
		var trans = ["link", "typed", "auto_bookmark", "auto_subframe", "manual_subframe", "generated", "start_page", "form_submit", "reload", "keyword", "keyword_generated"];
		var visitItems = new Array();
		for(var i=0; i<Math.floor(Math.random()*20);i++){
			var item = new Object();
			item.id = Math.floor(Math.random()*23252)+'';
			item.visitId = Math.floor(Math.random()*3423)+'';
			item.visitTime = new Date().getTime() - Math.random()*3*24*360000;
			item.referringVisitId = Math.floor(Math.random()*14213)+'';
			item.transition = trans[Math.floor(Math.random()*trans.length)];
			visitItems[i]=item;
		}
		return visitItems;
	}
	
	function filter(query, historyItems){
		var filtered = new Array();
		for(var i=0; i<historyItems.length;i++){
			if (str.indexOf(historyItems[i].title) != -1 || Math.random() < .05){
				filtered.push(historyItems[i]);
			}
		}
		return filtered;
	}
	
	
</script>	


</head>

<body>
</body>	
</html>